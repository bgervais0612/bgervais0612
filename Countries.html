<html lang="en">
    <head>
        <title>Final Project</title>
        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <h1>Rural Healthcare</h1>
        <style>
            .tooltip {
                text-anchor: middle;
                font-family: sans-serif;
                font-size: 12px;
                font-weight: bold;
                background-color: white;
                border-radius: 5px;
                color: black;
            }
            .map_titles {
                text-anchor: middle;
                font-family: sans-serif;
                font-size: 24px;
                font-weight: bold;
                fill: black;
            }
            .plot_titles {
                text-anchor: middle;
                font-family: sans-serif;
                font-size: 22px;
                font-weight: bold;
                fill: black;
            }
            .city_labels {
                text-anchor: middle;
                font-family: sans-serif;
                font-size: 10px;
                font-weight: bold;
                fill: black;
            }
            .axis path, .axis line {
			    fill: none;
			    stroke: black;
			    shape-rendering: crispEdges;
		    }
            .tick text {
			    fill: black;
			    font-size: 11px;
		    }
            .axis_labels {
                text-anchor: middle;
                font-size: 14px;
                fill: black;
            }
            .line {
                fill: none;
                stroke-width: 2px;

            }
            .legend_text {
                font-size: 11px;
                border-width: 2px;
                text-anchor: "left";
            }
            .border {
                fill: "none";
                stroke: black;
                stroke-width: 2px;
            }
        </style>

        
    </head>
    <body>
        <p>Access to healthcare in rural areas is important for the health and wellbeing of all Americans, 
            although this is not always the case. Throughout this webpage, I will explore statistics and locational
        data associated with the distribution of hospitals, doctors and obstetrics/gynocologists throughout my home state of Iowa,
    as well as explore how this compares to rural residents of larger states, such as Texas.</p>
        
        <p>Here are a couple maps to help visualize current healthcare access in the state of Iowa. </p>
        <script>
            var cities = {
                "Des Moines":[-93.624962,41.586834],
                "Iowa City":[-91.530128,41.661240],
                "Cedar Rapids":[-91.665627,41.977879],
                Davenport:[-90.577042,41.523529],
                Waterloo:[-92.343643,42.493469],
                "Council Bluffs":[-95.854362,41.258961],
                "Sioux City":[-96.404938,42.496342],
                "Mason City":[-93.201035,43.153572]

            }
            var svg = d3.select("body").append("svg")
                .attr("width",1000)
                .attr("height",830);

            var map1 = svg.append("g").attr("class","map");
            var map2 = svg.append("g").attr("class","map");
            var map3 = svg.append("g").attr("class","map");
            var map4 = svg.append("g").attr("class","map");

            var projection = d3.geo.mercator()
                .center([-96,37.5])
                .scale(3500);

            var path = d3.geo.path()
                .projection(projection);
            
            function draw_map1(state_data, county_data) {
                var colorScale1 = d3.scale.quantize()
                    .range(["rgb(237,248,233)","rgb(186,228,179)","rgb(116,196,118)","rgb(79,180,100)","rgb(49,163,84)","rgb(25,175,64)","rgb(0,189,44)"])
                    .domain([
                        d3.min(county_data.features,function(d) {return d.properties.num_gyns;}),
                        d3.max(county_data.features,function(d) {return d.properties.num_gyns;})
                ]);
                projection.translate([100,575]);

                map1.selectAll("path")
                    .data(state_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","black");
                
                map1.append("g")
                    .attr("class","county")
                    .selectAll("path")
                    .data(county_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","gray")
                    .style("stroke-width",0.5);

                map1.selectAll(".county path")
                    .data(county_data.features)
                    .transition()
                    .duration(200)
                    .style("fill",function(d) {
                        var value = d.properties.num_gyns;
                        if (value) {
                            if (value == 0) {
                                return "white";
                            } else {
                                return colorScale1(value);
                        }
                        } else {
                            return "white";

                        }

                    });
                
                map1.selectAll(".county path")
                    .data(county_data.features)
                    .on("mouseenter",function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)

                        var [xPosition,yPosition] = d3.mouse(this);

                        map1.append("text")
                            .attr("class","tooltip")
                            .attr("x",xPosition + 10)
                            .attr("y",yPosition - 10)
                            .text(d.properties.Name + ": " + d.properties.num_gyns);
                    })
                    .on("mouseleave",function() {
                        d3.select(".tooltip").remove();

                    });

                map1.append("text")
                    .attr("class","map_titles")
                    .attr("x",225)
                    .attr("y",50)
                    .text("Number of OBGYNs")

                map1.selectAll("circle")
                    .data(d3.entries(cities))
                    .enter()
                    .append("circle")
                    .attr("class","city")
                    .attr("cx",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("cy",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .style("fill","black")
                    .attr("r",3);

                map1.selectAll(".city_labels")
                    .data(d3.entries(cities))
                    .enter()
                    .append("text")
                    .attr("class","city_labels")
                    .attr("x",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("y",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .attr("dx",0)
                    .attr("dy",-10)
                    .text(function(d) {
                        return d.key;
                    });

                }
            
            function draw_map2(state_data, county_data) {
                var colorScale2 = d3.scale.quantize()
                    .range(["rgb(244,236,247)","rgb(232,218,239)","rgb(210,180,222)","rgb(187,143,206)","rgb(165,105,189)","rgb(142,68,173)","rgb(125,60,152)","rgb(108,52,131)","rgb(91,44,111)","rgb(74,35,90)"])
                    .domain([
                        d3.min(county_data.features,function(d) {return d.properties.crude_rate;}),
                        d3.max(county_data.features,function(d) {return d.properties.crude_rate;})
                ]);
                projection.translate([500,575]);

                map2.selectAll("path")
                    .data(state_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","black");
                
                map2.append("g")
                    .attr("class","county")
                    .selectAll("path")
                    .data(county_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","gray")
                    .style("stroke-width",0.5);

                map2.selectAll(".county path")
                    .data(county_data.features)
                    .transition()
                    .duration(200)
                    .style("fill",function(d) {
                        var value = d.properties.crude_rate;
                        if (value) {
                            if (value == 0) {
                                return "white";
                            } else {
                                return colorScale2(value);
                        }
                        } else {
                            return "white";

                        }

                    });
                
                map2.selectAll(".county path")
                    .data(county_data.features)
                    .on("mouseenter",function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)

                        var [xPosition,yPosition] = d3.mouse(this);

                        map2.append("text")
                            .attr("class","tooltip")
                            .attr("x",xPosition + 10)
                            .attr("y",yPosition - 10)
                            .text(d.properties.Name + ": " + d.properties.crude_rate);
                    })
                    .on("mouseleave",function() {
                        d3.select(".tooltip").remove();

                    });

                map2.append("text")
                    .attr("class","map_titles")
                    .attr("x",625)
                    .attr("y",50)
                    .text("OBGYNs per 100k")

                map2.selectAll("circle")
                    .data(d3.entries(cities))
                    .enter()
                    .append("circle")
                    .attr("class","city")
                    .attr("cx",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("cy",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .style("fill","black")
                    .attr("r",3);

                map2.selectAll(".city_labels")
                    .data(d3.entries(cities))
                    .enter()
                    .append("text")
                    .attr("class","city_labels")
                    .attr("x",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("y",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .attr("dx",0)
                    .attr("dy",-10)
                    .text(function(d) {
                        return d.key;
                    });
                }
            
            function draw_map3(state_data, county_data) {
                var filtered = county_data.features.filter(function(d) {
                    return d.properties.Name !== "Johnson";
                });

                var colorScale3 = d3.scale.quantize()
                    .range(["rgb(234,242,248)","rgb(212,230,241)","rgb(169,204,227)","rgb(127,179,213)","rgb(84,153,199)","rgb(41,128,185)","rgb(36,113,163)"])
                    .domain([
                        d3.min(county_data.features,function(d) {
                            return d.properties.physicians_per_10k;}),
                        d3.max(filtered,function(d) {
                            return d.properties.physicians_per_10k;})
                ]);

                projection.translate([100,975]);

                map3.selectAll("path")
                    .data(state_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","black");
                
                map3.append("g")
                    .attr("class","county")
                    .selectAll("path")
                    .data(county_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","gray")
                    .style("stroke-width",0.5);

                map3.selectAll(".county path")
                    .data(county_data.features)
                    .transition()
                    .duration(200)
                    .style("fill",function(d) {
                        var value = d.properties.physicians_per_10k;
                        if (value) {
                            if (value == 0) {
                                return "white";
                            } else {
                                return colorScale3(value);
                        }
                        } else {
                            return "white";

                        }

                    });
                
                map3.selectAll(".county path")
                    .data(county_data.features)
                    .on("mouseenter",function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)

                        var [xPosition,yPosition] = d3.mouse(this);

                        map3.append("text")
                            .attr("class","tooltip")
                            .attr("x",xPosition + 10)
                            .attr("y",yPosition - 10)
                            .text(d.properties.Name + ": " + d.properties.physicians_per_10k);
                    })
                    .on("mouseleave",function() {
                        d3.select(".tooltip").remove();

                    });

                map3.append("text")
                    .attr("class","map_titles")
                    .attr("x",225)
                    .attr("y",450)
                    .text("Number of Physicians per 10k")

                map3.selectAll("circle")
                    .data(d3.entries(cities))
                    .enter()
                    .append("circle")
                    .attr("class","city")
                    .attr("cx",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("cy",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .style("fill","black")
                    .attr("r",3);

                map3.selectAll(".city_labels")
                    .data(d3.entries(cities))
                    .enter()
                    .append("text")
                    .attr("class","city_labels")
                    .attr("x",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("y",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .attr("dx",0)
                    .attr("dy",-10)
                    .text(function(d) {
                        return d.key;
                    });
                }

            function draw_map4(state_data, county_data) {
                var colorScale4 = d3.scale.quantize()
                    .range(["rgb(249,235,234)","rgb(242,215,213)","rgb(230,176,170)","rgb(217,136,128)","rgb(205,97,85)","rgb(146,43,33)","rgb(123,36,28)"])
                    .domain([
                        d3.min(county_data.features,function(d) {return d.properties.substance_rate}),
                        d3.max(county_data.features,function(d) {return d.properties.substance_rate})
                ]);

                projection.translate([500,975]);

                map4.selectAll("path")
                    .data(state_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","black");

                map4.append("g")
                    .attr("class","county")
                    .selectAll("path")
                    .data(county_data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    .style("fill","white")
                    .style("stroke","gray")
                    .style("stroke-width",0.5);

                map4.selectAll(".county path")
                    .data(county_data.features)
                    .transition()
                    .duration(200)
                    .style("fill",function(d) {
                        var value = d.properties.substance_rate;
                        if (value) {
                            if (value == 0) {
                                return "white";
                            } else {
                                return colorScale4(value);
                            }
                        } else {
                            return "white";

                        }
                    });

                map4.selectAll(".county path")
                    .data(county_data.features)
                    .on("mouseenter",function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)

                            var [xPosition,yPosition] = d3.mouse(this);

                            map4.append("text")
                                .attr("class","tooltip")
                                .attr("x",xPosition + 10)
                                .attr("y",yPosition - 10)
                                .text(d.properties.Name + ": " + Math.round(d.properties.substance_rate*100)/100);
                    })
                    .on("mouseleave",function() {
                        d3.select(".tooltip").remove();

                    });

                map4.append("text")
                    .attr("class","map_titles")
                    .attr("x",625)
                    .attr("y",450)
                    .text("Substance Admissions per 10k")

                map4.selectAll("circle")
                    .data(d3.entries(cities))
                    .enter()
                    .append("circle")
                    .attr("class","city")
                    .attr("cx",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("cy",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .style("fill","black")
                    .attr("r",3);

                map4.selectAll(".city_labels")
                    .data(d3.entries(cities))
                    .enter()
                    .append("text")
                    .attr("class","city_labels")
                    .attr("x",function(d) {
                        return projection([d.value[0],d.value[1]])[0];
                    })
                    .attr("y",function(d) {
                        return projection([d.value[0],d.value[1]])[1];
                    })
                    .attr("dx",0)
                    .attr("dy",-10)
                    .text(function(d) {
                        return d.key;
                    });


            }

            d3.csv("OBGYN_by_county.csv",function(error,data) {
                if (error) {
                    console.error("Error",error);
                    return;
                }

                d3.json("counties.json",function(error,county) {
                    if (error) {
                        console.error("Error",error);
                        return;
                    }

                    for (i = 0; i < 99; i++) {
                        var county_name = data[i].county_name;
                        var county_name_lower = county_name.toLowerCase();
                        var num_gyns = parseFloat(data[i].Number);
                        var crude_rate = parseFloat(data[i].Crude_rate);
                        var physicians = parseFloat(data[i].physicians);
                        var phys_10k = parseFloat(data[i].physicians_per_10k);
                        var substance_rate = parseFloat(data[i].substance_rate);
                        
                        for (var j = 0; j < county.features.length; j++) {
                            var jsonCounty = county.features[j].properties.Name;

                            if (county_name_lower == jsonCounty) {
                                county.features[j].properties.Name = county_name;
                                county.features[j].properties.num_gyns = num_gyns;
                                county.features[j].properties.crude_rate = crude_rate;
                                county.features[j].properties.physicians = physicians;
                                county.features[j].properties.physicians_per_10k = phys_10k;
                                county.features[j].properties.substance_rate = substance_rate;
                                break;
                            }
                        }
                    }
                    d3.json("IA.geo.json",function(error,state) {
                        if (error) {
                            console.warn(error);
                            return;
                        }
                        draw_map1(state,county);
                        draw_map2(state,county);
                        draw_map3(state,county);
                        draw_map4(state,county);
                        
                });
            });
        }); 
        </script>
        <p>Based on this, you can see that certain counties (mostly rural) do not have any OBGYN providers in the county. 
            For certain communities, this only poses a 30 minute inconvenient commute to receive care. Other communities, specifically in
            the Northwest and Southern parts of the state, this commute could take up to 2 hours. In situations where care may be dire, 
            this becomes a serious issue. </p>
        <p>The same thing applies with general physicians. There are a few counties where the only healthcare access is a clinic, not a hospital. </p>
        
        <script>        
            var svg2 = d3.select("body").append("svg")
                .attr("width",1000)
                .attr("height",420);

            var pie = d3.layout.pie();

            var arc = d3.svg.arc()
                .innerRadius(0)
                .outerRadius(125);
            
  




            //Data filtering
            function filtered_data(county) {
                var no_obgyn = 0;
                var yes_obgyn = 0;

                for (var i = 0; i < 99; i++) {
                    var num_gyns = parseFloat(county[i].Number);

                    if (num_gyns == 0) {
                        no_obgyn += 1;
                    } else {
                        yes_obgyn += 1;
                    }
                }
                var ob_status = [yes_obgyn,no_obgyn];
                return ob_status;
            }

            function filtered_data2(county) {
                var less10 = 0;
                var more10 = 0;

                for (var i=0;i<99;i++) {
                    var phys = parseFloat(county[i].physicians_per_10k);

                    if (phys <= 10) {
                        less10 += 1;
                    } else {
                        more10 += 1;
                    }
                }
                return [more10,less10];
            }

            //Displaying pie charts
            function piechart1(filtered_data, county,pie) {

                var color = d3.scale.category10()
                    .domain([3,2]);

                var pie_chart = pie(filtered_data(county));

                var legend_labels = ["Yes OBGYN","No OBGYN"]

                var arcs = svg2.selectAll("g.arc")
                    .data(pie_chart)
                    .enter()
                    .append("g")
                    .attr("class","arc")
                    .attr("transform","translate(200,250)");

                arcs.append("path")
                    .style("fill",function(d,i) {
                        return color(i);})
                    .attr("d",arc);

                arcs.append("text")
                    .attr("transform",function(d) {
                        return "translate("+arc.centroid(d)+")";
                    })
                    .attr("text-anchor","middle")
                    .attr("class","pie_labels")
                    .text(function(d) {
                        return d.value + " counties";
                    });

                var legend = svg2.append("g")
                    .attr("class","legend1")
                    .selectAll(".legend")
                    .data(legend_labels)
                    .enter()
                    .append("g")
                    .attr("class","legend")
                    .attr("transform",function(d,i) {
                        return "translate(375,200)"
                    });

                legend.append("rect")
                    .attr("x",0)
                    .attr("y",function(d, i) {
                        return i*30;
                    })
                    .attr("width",18)
                    .attr("height",18)
                    .style("fill",function(d,i) {
                        return color(i);
                    });

                legend.append("text")
                    .attr("x",24)
                    .attr("y",function(d,i) {
                        return i*30 + 5;
                    })
                    .attr("dy",".35em")
                    .text(function(d) {
                        return d;
                    });

                svg2.append("text")
                    .attr("x",200)
                    .attr("y",80)
                    .attr("class","plot_titles")
                    .text("Counties without OBGYN Care");
                }

            function piechart2(filtered_data2, county,pie) {

                var color = d3.scale.category10()
                    .domain([3,2]);

                var pie_chart = pie(filtered_data2(county));

                var legend_labels2 = ["> 10 doctors per 10k","< 10 doctors per 10k"];

                var arcs = svg2.selectAll("g.arc2")
                    .data(pie_chart)
                    .enter()
                    .append("g")
                    .attr("class","arc2")
                    .attr("transform","translate(650,250)");

                arcs.append("path")
                    .style("fill",function(d,i) {
                        return color(i);})
                    .attr("d",arc);

                arcs.append("text")
                    .attr("transform",function(d) {
                        return "translate("+arc.centroid(d)+")";
                    })
                    .attr("text-anchor","middle")
                    .attr("class","pie_labels")
                    .text(function(d) {
                        return d.value + " counties";
                    });

                var legend = svg2.append("g")
                    .attr("class","legend2")
                    .selectAll(".legend2")
                    .data(legend_labels2)
                    .enter()
                    .append("g")
                    .attr("class","legend2")
                    .attr("transform",function(d,i) {
                        return "translate(400,200)"
                    });

                legend.append("rect")
                    .attr("x",400)
                    .attr("y",function(d, i) {
                        return i*30;
                    })
                    .attr("width",18)
                    .attr("height",18)
                    .style("fill",function(d,i) {
                        return color(i);
                    });

                legend.append("text")
                    .attr("x",425)
                    .attr("y",function(d,i) {
                        return i*30 + 5;
                    })
                    .attr("dy",".35em")
                    .text(function(d) {
                        return d;
                    });

                svg2.append("text")
                    .attr("x",650)
                    .attr("y",80)
                    .attr("class","plot_titles")
                    .text("Less than 10 doctors per 10k");
}

            d3.csv("OBGYN_by_county.csv",function(error,county) {
                if (error) {
                    console.error("Error",error);
                    return;
                }
                
                piechart1(filtered_data,county,pie);

                piechart2(filtered_data2,county,pie);

            });

        </script>
        <p>As you can see, 2/3 of Iowa counties do not have an OBGYN, nor do they have at least 10 
            physicians per 10k residents. Of the counties with less than 10 doctors per 10k, 34 (exactly half) of those counties have less
            than 5 doctors per 10k. 
        </p>
        <p>This trend could be caused by a variety of factors, including education, the fact that rural communities
            often have fewer women of childbearing age, and socio-economics. Throughout the remainer of this report, 
            I will explore a few correlations that may cause such lack of access for rural communities. 
        </p>
        <script>
            var svg3 = d3.select("body").append("svg")
                .attr("width",1000)
                .attr("height",600);

            var data = [];

            function plot_1(data) {
                var plot1 = svg3.append("g")

                var plot_w = 700;
                var plot_h = 400;
                var offset = 100;

                var xScale = d3.scale.linear()
                    .domain([d3.min(data,function(d) {return d.physicians;}),
                        d3.max(data,function(d) {return d.physicians;})])
                    .range([offset,plot_w + offset]);

                var yScale = d3.scale.linear()
                    .domain([0,
                        d3.max(data,function(d) {return d.substance_rate;})])
                    .range([plot_h + offset,offset]);

                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(function(d) {return "" + d;});

                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");

                plot1.append("g")
                    .attr("class","axis")
                    .attr("transform","translate(0," + (plot_h + offset) +")")
                    .call(xAxis)

                plot1.append("text")
                    .attr("x",(plot_w/2)+offset)
                    .attr("y",offset+plot_h+50)
                    .attr("class","axis_labels")
                    .text("Physicians per 10k");

                plot1.append("g")
                    .attr("class","axis")
                    .attr("transform","translate("+offset+",0)")
                    .call(yAxis);

                plot1.append("text")
                    .attr("transform","rotate(-90)")
                    .attr("x",(-plot_h/2) -offset)
                    .attr("y",offset-35)
                    .attr("class","axis_labels")
                    .text("Substance admissions per 10k");

                plot1.append("text")
                    .attr("class","plot_titles")
                    .attr("x",(plot_w/2) + offset)
                    .attr("y",offset-35)
                    .text("Substance Admissions vs. Physicians");

                plot1.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .style("fill","steelblue")
                    .attr("r",4)
                    .attr("cx",function(d) {return xScale(d.physicians);})
                    .attr("cy",function(d) {return yScale(d.substance_rate);});

                plot1.selectAll("circle")
                    .data(data)
                    .on("mouseover",function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","red")
                            .attr("r",5)

                        var [xPosition,yPosition] = d3.mouse(this);

                        plot1.append("text")
                            .attr("class","tooltip")
                            .attr("x",xPosition + 20)
                            .attr("y",yPosition + 20)
                            .text("County: " + d.Name)
                            //ghj
                            .append("tspan")
                            .attr("x",xPosition + 20)
                            .attr("dy","1.2em")
                            .text("Physicians: " + d.physicians)
                            //ghj
                            .append("tspan")
                            .attr("x",xPosition + 20)
                            .attr("dy","1.2em")
                            .text("Substance Rate: " + d.substance_rate);
                    })
                    .on("mouseout",function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","steelblue")
                            .attr("r",4)
                        d3.select(".tooltip").remove()
                    });

                var description = plot1.append("g");

                description.append("text")
                    .attr("class","description")
                    .attr("x",offset + (2*plot_w/3))
                    .attr("y",offset + (plot_h/3))
                    .text("Hover over each point to display the county,")
                    //line2
                    .append("tspan")
                    .attr("x",offset + (2*plot_w/3))
                    .attr("dy","1.2em")
                    .text("physician and substance rate of each county.");

                var bbox = description.select("text").node().getBBox();

                description.append("rect")
                    .attr("class","border")
                    .attr("x",bbox.x - 10)
                    .attr("y",bbox.y - 10)
                    .attr("width",bbox.width + 20)
                    .attr("height",bbox.height + 20)
                    .attr("fill","none")
                    .attr("stroke","black")
                    .attr("stroke-width",2);
            }
            d3.csv("OBGYN_by_county.csv",function(error,health_data){
                if (error) {
                    console.error("Error",error)
                    return;
                }

                for (var i = 0; i < 99; i++) {
                    var county_name = health_data[i].county_name;
                    var physicians = parseFloat(health_data[i].physicians_per_10k);
                    var substance_rate = parseFloat(health_data[i].substance_rate);
                        
                    data.push({
                        Name: county_name,
                        physicians: physicians,
                        substance_rate: substance_rate
                    });
                    }


                    plot_1(data);

                });


        </script>
        <p>How do the Substance Admissions Rates and Number of Doctors per capita compare with the educational outlooks of 
            their respective counties? The number being used is the average English Language Arts proficiency levels of the schools in 
            a specific county. For example, I live in Shelby county. The number computed would represent the average of the percentages of 
            students proficient in English between the two county school: Harlan and Exira-EHK. The data is based off of proficiency scores for 
            the 2023-2024 8th grade class. 
        </p>
        <script>
            var svg4 = d3.select("body").append("svg")
                .attr("width",1000)
                .attr("height",600)

            function plot_substance(data) {

                var plot2 = svg4.append("g")
                    .attr("class","lineplot1")

                var offset = 125;
                var plot_h = 350;
                var plot_w = 350;

                var xScale = d3.scale.linear()
                    .domain([d3.min(data,function(d) {return d.Proficiency_rate;})-10,
                    d3.max(data,function(d) {return d.Proficiency_rate;})+10])
                    .range([offset,plot_w+offset]);

                var yScale = d3.scale.linear()
                    .domain([0,d3.max(data,function(d) {return d.Substance_rate;})+10])
                    .range([plot_h+offset,offset]);

                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom");
                
                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");

                plot2.append("g")
                    .attr("class","axis")
                    .attr("transform","translate(0,"+(offset+plot_h)+")")
                    .call(xAxis);

                plot2.append("g")
                    .attr("class","axis")
                    .attr("transform","translate("+offset+",0)")
                    .call(yAxis);

                plot2.selectAll("circle")
                    .attr("class","points")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx",function(d) {return xScale(d.Proficiency_rate);})
                    .attr("cy",function(d) {return yScale(d.Substance_rate);})
                    .attr("r",4)
                    .style("fill","forestgreen");

                plot2.selectAll("circle")
                    .data(data)
                    .on("mouseover",function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","red")
                            .attr("r",5)

                        var [xPosition,yPosition] = d3.mouse(this);

                        plot2.append("text")
                            .attr("class","tooltip")
                            .attr("x",xPosition + 20)
                            .attr("y",yPosition + 20)
                            .text("County: " + d.Name)
                            // Proficiency Rate
                            .append("tspan")
                            .attr("x",xPosition + 20) 
                            .attr("dy","1.2em")
                            .text("Proficiency Rate: " + (Math.round(d.Proficiency_rate*100))/100 + "%")
                            // Substance Rate
                            .append("tspan")
                            .attr("x",xPosition + 20)
                            .attr("dy","1.2em")
                            .text("Substance Rate: " + d.Substance_rate)
                        })
                    .on("mouseout",function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","forestgreen")
                            .attr("r",4)
                        d3.select(".tooltip").remove()
                    });

                plot2.append("text")
                    .attr("class","axis_labels")
                    .attr("x",(plot_w/2)+offset)
                    .attr("y",plot_h + offset+50)
                    .text("ELA Proficiency (%)")

                plot2.append("text")
                    .attr("class","axis_labels")
                    .attr("x",-offset-(plot_h/2))
                    .attr("y",offset-50)
                    .attr("transform","rotate(-90)")
                    .text("Substance Admissions per 10k");

                plot2.append("text")
                    .attr("class","plot_titles")
                    .attr("x",plot_w/2 + offset)
                    .attr("y",offset-50)
                    .text("Proficiency vs. Substance Use");

                var slope = -.677;
                var intercept = 125.5;

                var slope_ci = -.678;
                var intercept_ci = 187.004;

                var xMin = xScale.domain()[0];
                var xMax = xScale.domain()[1];
                var yMin = slope * xMin + intercept;
                var yMax = slope * xMax + intercept;

                plot2.append("line")
                    .attr("x1",xScale(xMin))
                    .attr("y1",yScale(yMin))
                    .attr("x2",xScale(xMax))
                    .attr("y2",yScale(yMax))
                    .attr("stroke","blue")
                    .attr("stroke-width",2);

                plot2.append("line")
                    .attr("x1",xScale(xMin))
                    .attr("y1",yScale(slope_ci*xMin + intercept_ci))
                    .attr("x2",xScale(xMax))
                    .attr("y2",yScale(slope_ci*xMax + intercept_ci))
                    .attr("stroke","red")
                    .attr("stroke-width",2)
                    .attr("stroke-dasharray","5,5");

                plot2.append("line")
                    .attr("x1",xScale(xMin))
                    .attr("y1",yScale(-.676*xMin + 63.995))
                    .attr("x2",xScale(94.6671))
                    .attr("y2",yScale(0))
                    .attr("stroke","red")
                    .attr("stroke-width",2)
                    .attr("stroke-dasharray","5,5");


            }

            function plot_physicians(data) {
                var plot3 = svg4.append("g")
                    .attr("class","lineplot2")

                var offset = 125;
                var plot_h = 350;
                var plot_w = 350;

                var xScale = d3.scale.linear()
                    .domain([d3.min(data,function(d) {return d.Proficiency_rate;})-10,
                    d3.max(data,function(d) {return d.Proficiency_rate;})+10])
                    .range([offset,plot_w+offset]);

                var yScale = d3.scale.linear()
                    .domain([0,d3.max(data,function(d) {return d.Physicians;})+10])
                    .range([plot_h+offset,offset]);

                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom");
                
                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");

                plot3.append("g")
                    .attr("class","axis")
                    .attr("transform","translate("+(offset + plot_w)+","+(offset+plot_h)+")")
                    .call(xAxis);

                plot3.append("g")
                    .attr("class","axis")
                    .attr("transform","translate("+(offset*2 + plot_w)+",0)")
                    .call(yAxis);

                plot3.selectAll("circle")
                    .attr("class","points")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx",function(d) {return xScale(d.Proficiency_rate)+plot_w+offset;})
                    .attr("cy",function(d) {return yScale(d.Physicians);})
                    .attr("r",4)
                    .style("fill","forestgreen");

                plot3.selectAll("circle")
                    .data(data)
                    .on("mouseover",function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","red")
                            .attr("r",5)

                        var [xPosition,yPosition] = d3.mouse(this);

                        plot3.append("text")
                            .attr("class","tooltip")
                            .attr("x",xPosition + 20)
                            .attr("y",yPosition + 20)
                            .text("County: " + d.Name)
                            // Proficiency Rate
                            .append("tspan")
                            .attr("x",xPosition + 20) 
                            .attr("dy","1.2em")
                            .text("Proficiency Rate: " + (Math.round(d.Proficiency_rate*100))/100 + "%")
                            // Substance Rate
                            .append("tspan")
                            .attr("x",xPosition + 20)
                            .attr("dy","1.2em")
                            .text("Physicians: " + d.Physicians)
                        })
                    .on("mouseout",function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","forestgreen")
                            .attr("r",4)
                        d3.select(".tooltip").remove()
                    });

                plot3.append("text")
                    .attr("class","axis_labels")
                    .attr("x",(plot_w*1.5) + 2*offset)
                    .attr("y",plot_h + offset+50)
                    .text("ELA Proficiency (%)")

                plot3.append("text")
                    .attr("class","axis_labels")
                    .attr("x",-offset-(plot_h/2))
                    .attr("y",plot_w + 2*offset - 50)
                    .attr("transform","rotate(-90)")
                    .text("Physicians per 10k");

                plot3.append("text")
                    .attr("class","plot_titles")
                    .attr("x",(plot_w*1.5) + 2*(offset))
                    .attr("y",offset-50)
                    .text("Proficiency vs. Physicians");


                var slope_ci = -.678;
                var intercept_ci = 187.004;

                var xMin = xScale.domain()[0];
                var xMax = xScale.domain()[1];

                plot3.append("line")
                    .attr("x1",xScale(xMin)+plot_w + offset)
                    .attr("y1",yScale(.0676*xMin + 2.5329))
                    .attr("x2",xScale(xMax)+plot_w + offset)
                    .attr("y2",yScale(.0676*xMin + 2.5329))
                    .attr("stroke","blue")
                    .attr("stroke-width",2);

            }
            
            d3.csv("OBGYN_by_county.csv",function(error,health_data){
                if (error) {
                    console.error("Error",error)
                    return;
                }

                d3.csv("Proficiency_rates_ela_updated.csv",function(error,school_data) {
                    if (error) {
                        console.error("Error",error)
                        return;
                    }

                    var schoolDict = {};
                    school_data.forEach(function(school) {
                        if (school.Grade_8_proficient != "") {
                            var county_school = school.county_name.replace(" ","").toLowerCase();
                            var proficiency = parseFloat(school.Grade_8_proficient);
                        } else {
                            return;
                        }

                        if (county_school in schoolDict) {
                            schoolDict[county_school].Proficiency += proficiency;
                            schoolDict[county_school].Num_schools += 1; 
                        } else {
                            schoolDict[county_school] = {
                                Proficiency: proficiency,
                                Num_schools: 1
                            };
                        }
                    });

                    var ed_data = [];
                    health_data.forEach(function (health) {
                        var county_name = health.county_name;
                        var county_name_str = county_name.toLowerCase();
                        var physicians = parseFloat(health.physicians_per_10k) || 0;
                        var substance_rate = parseFloat(health.substance_rate) || 0;

                        if (county_name_str in schoolDict) {
                            if (isNaN(schoolDict[county_name_str].Proficiency)) {
                                return;
                            } else {
                                ed_data.push({
                                    Name: county_name,
                                    Physicians: physicians,
                                    Substance_rate: substance_rate,
                                    Proficiency_rate: (schoolDict[county_name_str].Proficiency/schoolDict[county_name_str].Num_schools),
                            });
                            }

                        }
                    });
                    var dataJson = JSON.stringify(ed_data);

                    plot_substance(ed_data);
                    plot_physicians(ed_data);
                });

            });

        </script>
        <p>While this data doesn't appear to have the strongest correlation, a few conclusions can be made. 
            First, there are a few counties that are significantly higher substance admissions rates than the rest, lying above the 95% prediction interval. 
            This prediction interval was generated by transferring the data to R and then plotting the line of best fit, based on the determined 
            slope and intercept. There is a slight negative correlation. According to the best fitting line, for every extra 1 percent of ELA proficiency, 
            the Substance Admissions rate drops by .67. 
        </p>
        <p>As for the correlation between the number of doctors and ELA proficiency, there is no correlation. 
           Johnson county happens to be a major outlier, with twice as many physicians per capita as the second place county. This is likely
           due to the fact that Johnson county is home to the University of Iowa and a very large research hospital. 
        </p>
        <h3>How does Iowa compare to other states?</h3>
        <p>The below graphic compares the number of doctors per 10k people to the percent of 8th grade
            students at or above proficiency and at or above basic level in reading, after completing the 2022 state standardized test. 
            The ranks were determined by ordering the averages between the basic and proficient levels. Hover over a bar to see the stats!!!
        </p>
        <script>
            var svg5 = d3.select("body").append("svg")
                .attr("width",1300)
                .attr("height",700);

            function barplot_states(data) {
                var plot4 = svg5.append("g")
                    .attr("class","plot4");
                
                var offset = 100;
                var plot_h = 450;
                var plot_w = 1000-(offset);

                var bar_width = 16;

                var yScale = d3.scale.linear()
                    .domain([d3.min(data,function(d) {return d.Physicians-50;}),
                    d3.max(data,function(d) {return d.Physicians;})])
                    .range([plot_h + offset,offset-20]);

                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");

                plot4.append("g")
                    .attr("class","axis")
                    .attr("transform","translate("+offset+",0)")
                    .call(yAxis);

                plot4.selectAll(".bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class","bar")
                    .attr("x",function(d,i) {
                        return offset + i*(bar_width + 1);
                    })
                    .attr("y",function(d) {
                        return yScale(d.Physicians);
                    })
                    .attr("width",bar_width)
                    .attr("height",function(d) {
                        return plot_h + offset - yScale(d.Physicians);
                    })
                    .style("fill","#70db70");
                
                plot4.selectAll(".labels")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class","labels")
                    .attr("x",function(d,i) {
                        return i*(bar_width+1)-45;
                    })
                    .attr("y",plot_h+52+offset)
                    .attr("transform",function(d,i) {
                        return "rotate(-90,"+(i*(bar_width+1)+bar_width/2)+","+(plot_h+50)+")";
                    })
                    .style("text-anchor","end")
                    .style("font-size","11px")
                    .style("font","sans-serif")
                    .text(function(d) {
                        return d.State;
                    });

                plot4.selectAll(".phys_labels")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class","phys_labels")
                    .attr("transform",function(d,i) {
                        return "rotate(-90,"+(offset+((bar_width+1)*i))+","+yScale(d.Physicians)+")";
                    })
                    .attr("x",function(d,i) {
                        return (i*(bar_width + 1))+offset-5;
                    })
                    .attr("y",function(d) {return yScale(d.Physicians)+10;})
                    .style("text-anchor","end")
                    .style("font-size","11px")
                    .style("font","sans-serif")
                    .style("fill","white")
                    .text(function(d) {
                        return d.Physicians;
                    });

                var yScale2 = d3.scale.linear()
                    .domain([0,100])
                    .range([plot_h + offset,offset-20]);

                var yAxis2 = d3.svg.axis()
                    .scale(yScale2)
                    .orient("right");

                plot4.append("g")
                    .attr("class","axis")
                    .attr("transform","translate("+(offset+plot_w-33)+",0)")
                    .call(yAxis2);

                plot4.selectAll(".prof-points")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class","prof-points")
                    .attr("cx",function(d,i) {
                        return (i*(bar_width+1) + offset+(bar_width/2));
                    })
                    .attr("cy",function(d) {
                        return yScale2(d.Proficient);
                    })
                    .attr("r",4)
                    .style("fill","blue");

                plot4.selectAll(".basic-points")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class","basic-points")
                    .attr("cx",function(d,i) {
                        return (i*(bar_width+1) + offset+(bar_width/2));
                    })
                    .attr("cy",function(d) {
                        return yScale2(d.Basic);
                    })
                    .attr("r",4)
                    .style("fill","#b30000");

                var PathGen1 = d3.svg.line()
                    .x(function(d,i) {return (i*(bar_width+1) + offset+(bar_width/2));})
                    .y(function(d) {return yScale2(d.Proficient);});

                
                var PathGen2 = d3.svg.line()
                    .x(function(d,i) {return (i*(bar_width+1) + offset+(bar_width/2));})
                    .y(function(d) {return yScale2(d.Basic);});

                plot4.append("path")
                    .attr("class","line")
                    .style("stroke","blue")
                    .attr("d",PathGen1(data));

                plot4.append("path")
                    .attr("class","line")
                    .style("stroke","#b30000")
                    .attr("d",PathGen2(data))

                plot4.append("text")
                    .attr("x",plot_w+50)
                    .attr("y",60)
                    .text("Percent (%)");

                plot4.append("text")
                    .attr("class","plot_titles")
                    .attr("x",offset + (plot_w/2))
                    .attr("y",50)
                    .text("Physicians per Capita vs. Proficiency Levels")

                legend4 = plot4.append("g")
                    .attr("class","legend4")
                    .attr("transform","translate("+(offset+(2*plot_w/3))+","+offset+")");

                legend4.append("rect")
                    .attr("class","legend_lines")
                    .attr("x",0)
                    .attr("y",0)
                    .attr("height",3)
                    .attr("width",10)
                    .style("fill","#b30000");

                legend4.append("rect")
                    .attr("class","legend_lines")
                    .attr("x",0)
                    .attr("y",20)
                    .attr("height",3)
                    .attr("width",10)
                    .style("fill","blue");

                legend4.append("text")
                    .attr("class","legend_text")
                    .attr("x",20)
                    .attr("y",0)
                    .text("At or above Proficiency");

                
                legend4.append("text")
                    .attr("class","legend_text")
                    .attr("x",20)
                    .attr("y",20)
                    .text("At or above Basic");

                var bbox = legend4.node().getBBox();

                legend4.append("rect")
                    .attr("class","border")
                    .attr("x",bbox.x - 10)
                    .attr("y",bbox.y - 10)
                    .attr("width",bbox.width + 20)
                    .attr("height",bbox.height + 20)
                    .attr("fill","none")
                    .attr("stroke","black")
                    .attr("stroke-width",2);

                var state_tooltip = plot4.append("g");

                plot4.selectAll(".bar")
                    .data(data)
                    .on("mouseover", function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","#1f7A1f")

                        var [xPos,yPos] = d3.mouse(this);

                        state_tooltip.append("rect")
                            .attr("class","tooltip_background")
                            .attr("x",xPos - 35)
                            .attr("y",yPos + 15)
                            .attr("width",135)
                            .attr("height",80)
                            .style("fill","white")
                            .style("stroke-width",1.5)
                            .style("stroke","black");
                        
                        state_tooltip.append("text")
                            .attr("class","tooltip")
                            .attr("x",xPos + 30)
                            .attr("y",yPos + 30)
                            .text(d.State)
                            .style("font-weight","bold")
                            //Physicians
                            .append("tspan")
                            .attr("x",xPos + 30)
                            .attr("dy","1.2em")
                            .text("Physicians: " + d.Physicians)
                            .style("font-weight","normal")
                            //Proficient
                            .append("tspan")
                            .attr("x",xPos + 30)
                            .attr("dy","1.2em")
                            .text("Proficient: " + d.Proficient + "%")
                            //Basic
                            .append("tspan")
                            .attr("x",xPos + 30)
                            .attr("dy","1.2em")
                            .text("Basic: " + d.Basic + "%")
                            //Educational Rank
                            .append("tspan")
                            .attr("x",xPos + 30)
                            .attr("dy","1.2em")
                            .text("Educational Rank: " + d.Rank);

                    })
                    .on("mouseout",function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style("fill","#70db70")

                        state_tooltip.selectAll("*").remove()
                    });

                
                    

            }


            d3.csv("Physician_rate_per_state2.csv",function(error,states) {
                if (error) {
                    console.error("Error:",error)
                    return;
                }
                var data = [];
                var rank = 1;

                for (var i = 0; i < 51; i++) {
                    var state_name = states[i].State;
                    var physicians = parseFloat(states[i].Phys_per_100k);
                    var act_score = parseFloat(states[i].ACTCompositeScore);
                    var sat_score = parseFloat(states[i].SATCompositeScore);
                    var grad_rate = parseFloat(states[i].HSGradRate);
                    var degree = parseFloat(states[i].TotalBSDegreeOrHigher);
                    var obgyn_rate = parseFloat(states[i].ObgynRate);
                    var basic = parseFloat(states[i].Basic);
                    var proficient_ela = parseFloat(states[i].Proficient);

                    data.push({
                        State: state_name,
                        Physicians: physicians,
                        Average_ACT_score: act_score,
                        Average_SAT_score: sat_score,
                        Graduation_rate: grad_rate,
                        BS_or_Higher: degree,
                        OBGYN_per_100k: obgyn_rate,
                        Basic: basic,
                        Proficient: proficient_ela,
                        Avg: (basic + proficient_ela)/2,

                    });

                }
                data.sort((a,b) => b.Avg - a.Avg);

                data.forEach((d,i) => {
                    if (i > 0 && d.Avg === data[i-1].Avg) {
                        d.Rank = data[i-1].Rank;
                    } else { 
                        d.Rank = rank;
                    }
                    rank++;
                })
                data.sort((a,b) => b.Physicians - a.Physicians);


                console.log(data)
                barplot_states(data);

            })
        </script>
        <p>As you can seemany of the states that rank high in per capita doctors, also rank relatively high on the educational spectrum. For instance, 
            Massachusetts ranks both 2nd in per capita doctors and in education. Vermont ranks 4th in both and New Jersey ranks 1st in education and 10th in doctors. 
            On the other side of the spectrum, Mississippi and Oklahoma rank relatively low in both education and physicians. This is not the case for every state, such as Idaho 
            and Utah, that rank relatively high in education but low in the number of doctors per capita, or Washington D.C, that ranks last in student performance, but first in Physicians. 

        </p>
        <p>
            Overall, you can begin to see the correlations between access to healthcare, education, substance abuse and how it might affect individuals in rural communities. 
        </p>
    </body>
</html>